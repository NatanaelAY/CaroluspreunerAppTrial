import React, { useState, useEffect } from 'react';
import { 
  BookOpen, Play, CheckCircle, Award, TrendingUp, Truck, Package, 
  User, Star, Heart, ArrowRight, RefreshCcw, ChevronRight, ChevronLeft, 
  Briefcase, Zap, XCircle, Home, Trophy, Target, Lock, Coins, Factory, ShoppingBag,
  BrainCircuit, LineChart, Globe, Rocket, Users, Megaphone, Store, Crown, Gem
} from 'lucide-react';

// --- UTILS ---
const FormatText = ({ text }) => {
  if (!text) return null;
  const parts = text.split(/(\*\*.*?\*\*)/g);
  return (
    <span>
      {parts.map((part, index) => {
        if (part.startsWith('**') && part.endsWith('**')) {
          return <strong key={index} className="text-indigo-700 font-extrabold">{part.slice(2, -2)}</strong>;
        }
        return part;
      })}
    </span>
  );
};

// --- DATA LEVELLING (Bertingkat dengan Difficulty) ---
const LEVELS = [
  {
    id: 1,
    title: "Level 1: Si Perintis",
    subtitle: "Konsep & Kelangkaan",
    difficulty: "Easy",
    rewardMoney: 5000,
    icon: <TrendingUp />,
    color: "bg-blue-500",
    accent: "border-blue-600",
    materialIds: [0],
    quizId: 'quiz_1',
    minScore: 100,
    locked: false
  },
  {
    id: 2,
    title: "Level 2: Juragan Produksi",
    subtitle: "Faktor Produksi & Nilai Guna",
    difficulty: "Medium",
    rewardMoney: 10000,
    icon: <Factory />,
    color: "bg-amber-500",
    accent: "border-amber-600",
    materialIds: [1],
    quizId: 'quiz_2',
    minScore: 100,
    locked: true
  },
  {
    id: 3,
    title: "Level 3: Raja Pasar",
    subtitle: "Distribusi & Konsumsi",
    difficulty: "Medium",
    rewardMoney: 15000,
    icon: <Truck />,
    color: "bg-emerald-500",
    accent: "border-emerald-600",
    materialIds: [2],
    quizId: 'quiz_3',
    minScore: 100,
    locked: true
  },
  {
    id: 4,
    title: "Level 4: Analis Krisis (HOTS)",
    subtitle: "Analisis Masalah Ekonomi",
    difficulty: "Hard",
    rewardMoney: 50000,
    icon: <BrainCircuit />,
    color: "bg-rose-500",
    accent: "border-rose-600",
    materialIds: [3],
    quizId: 'quiz_4',
    minScore: 150,
    locked: true
  },
  {
    id: 5,
    title: "Level 5: Strategi CEO (Studi Kasus)",
    subtitle: "Pengambilan Keputusan Bisnis",
    difficulty: "Expert",
    rewardMoney: 100000,
    icon: <LineChart />,
    color: "bg-violet-600",
    accent: "border-violet-700",
    materialIds: [4],
    quizId: 'quiz_5',
    minScore: 150,
    locked: true
  },
  {
    id: 6,
    title: "Level 6: Raja Ekspor (Master)",
    subtitle: "Perdagangan Internasional",
    difficulty: "Master",
    rewardMoney: 250000,
    icon: <Globe />,
    color: "bg-cyan-600",
    accent: "border-cyan-700",
    materialIds: [5],
    quizId: 'quiz_6',
    minScore: 200, // Makin susah
    locked: true
  },
  {
    id: 7,
    title: "Level 7: Tycoon Legendaris",
    subtitle: "Penguasaan Ekonomi Total",
    difficulty: "Legend",
    rewardMoney: 500000,
    icon: <Crown />,
    color: "bg-yellow-500",
    accent: "border-yellow-600",
    materialIds: [6],
    quizId: 'quiz_7',
    minScore: 250, // Sangat susah
    locked: true
  }
];

// --- DATA MATERI ---
const studyMaterials = [
  // Level 1-3 (Existing)
  {
    title: "Misi 1: Memahami Masalah Ekonomi",
    emoji: "‚öñÔ∏è",
    content: [
      {
        title: "Masalah Ekonomi Utama",
        text: "Bayangkan kamu punya uang Rp10.000, tapi ingin beli Bakso (Rp10rb) DAN Es Teh (Rp5rb). Kamu tidak bisa beli keduanya, kan?\n\nItulah **Kelangkaan (Scarcity)**. Kebutuhan manusia TIDAK TERBATAS, tapi alat pemuasnya (uang/sumber daya) TERBATAS."
      },
      {
        title: "Siklus Kegiatan Ekonomi",
        text: "Agar hidup terus berjalan, manusia melakukan 3 hal utama:\n\n1. **Produksi** (Membuat)\n2. **Distribusi** (Mengantar)\n3. **Konsumsi** (Memakai)\n\nKetiganya saling berputar tanpa henti!"
      }
    ]
  },
  {
    title: "Misi 2: Rahasia Dapur Produksi",
    emoji: "üè≠",
    content: [
      {
        title: "Apa itu Produksi?",
        text: "Bukan cuma pabrik asap lho! Produksi adalah kegiatan **menambah nilai guna** suatu barang.\n\nContoh: Kayu di hutan (murah) ‚û°Ô∏è Diubah jadi Meja Belajar (mahal & berguna)."
      },
      {
        title: "Studi Kasus: Tempe Mendoan",
        text: "Ingat contoh di PDF?\n\n**Nilai Guna Bentuk (Form Utility):**\nKedelai (Biasa Aja) ‚û°Ô∏è Difermentasi ‚û°Ô∏è Jadi Tempe (Enak & Mahal).\n\nInilah keajaiban produksi!"
      },
      {
        title: "4 Resep Rahasia (Faktor Produksi)",
        text: "Untuk membuat produk, kamu butuh:\n\n1. **Alam** (Bahan baku)\n2. **Tenaga Kerja** (Manusia)\n3. **Modal** (Mesin/Uang)\n4. **Keahlian** (Skill Bos/Manager)"
      }
    ]
  },
  {
    title: "Misi 3: Menguasai Pasar",
    emoji: "üöö",
    content: [
      {
        title: "Jalur Distribusi",
        text: "Bagaimana barang sampai ke tanganmu?\n\nüöö **Langsung:** Penjual Gorengan (Masak langsung jual).\nüè™ **Semi-Langsung:** Toko Roti (Punya pabrik & toko sendiri).\nüì¶ **Tidak Langsung:** Indomaret (Jual barang dari pabrik lain)."
      },
      {
        title: "Seni Konsumsi",
        text: "Konsumsi bukan cuma makan, tapi **menghabiskan nilai guna**.\n\nApa yang bikin kamu beli barang?\n- **Internal:** Selera, Gengsi (Status).\n- **Eksternal:** Harga Diskon, Budaya, Iklan."
      }
    ]
  },
  // Level 4 & 5 (HOTS & Studi Kasus)
  {
    title: "Misi 4: Analisis Masalah (HOTS)",
    emoji: "üß†",
    content: [
      {
        title: "Dampak Berantai Ekonomi",
        text: "Ekonomi itu seperti efek domino. Jika **Harga BBM Naik**, apa yang terjadi?\n\n1. Biaya Distribusi Mahal ‚û°Ô∏è\n2. Harga Barang Naik ‚û°Ô∏è\n3. Daya Beli Masyarakat Turun ‚û°Ô∏è\n4. Pabrik Kurangi Produksi (PHK).\n\nSeorang pengusaha harus bisa memprediksi ini!"
      },
      {
        title: "Efisiensi vs Efektifitas",
        text: "Dalam produksi, kita harus **Efisien** (Hemat Biaya) dan **Efektif** (Tepat Sasaran).\n\nContoh salah: Hemat bahan baku (Efisien) tapi kualitas jelek (Tidak Efektif) = Konsumen kabur!"
      }
    ]
  },
  {
    title: "Misi 5: The CEO Mindset",
    emoji: "üíº",
    content: [
      {
        title: "Menghadapi Kelangkaan",
        text: "Apa yang harus dilakukan CEO jika bahan baku langka?\n\n1. **Substitusi:** Ganti bahan lain (Misal: Kedelai mahal ganti Kacang Koro?)\n2. **Inovasi:** Buat produk baru yang tidak butuh bahan itu.\n3. **Efisiensi:** Kurangi limbah produksi sekecil mungkin."
      },
      {
        title: "Strategi Memenangkan Persaingan",
        text: "Pesaing menurunkan harga? Jangan panik!\n\nJangan ikut perang harga jika modal tipis. Fokuslah pada **Kualitas** dan **Pelayanan**. Pelanggan setia rela bayar lebih mahal demi kepuasan!"
      }
    ]
  },
  // NEW Level 6 & 7
  {
    title: "Misi 6: Go Global (Ekspor)",
    emoji: "üåç",
    content: [
      {
        title: "Mengapa Ekspor?",
        text: "Pasar lokal sudah penuh? Jual ke luar negeri!\n\n**Keuntungan Ekspor:**\n1. Pasar lebih luas (Miliaran manusia).\n2. Mendapat Devisa (Mata uang asing).\n3. Skala produksi makin besar (Mass Production)."
      },
      {
        title: "Tantangan Global",
        text: "Jualan di luar negeri tidak mudah. Kamu harus perhatikan:\n- **Kualitas Standar Internasional** (ISO).\n- **Selera Asing** (Orang Jepang suka tempe yang higienis).\n- **Hambatan Perdagangan** (Pajak/Bea Cukai)."
      }
    ]
  },
  {
    title: "Misi 7: Rahasia Tycoon Abadi",
    emoji: "üíé",
    content: [
      {
        title: "Diversifikasi Bisnis",
        text: "Jangan taruh semua telur dalam satu keranjang! \n\nJika bisnis tempe sedang lesu, pastikan kamu punya bisnis lain (misal: Logistik atau Properti). Inilah rahasia kekayaan jangka panjang."
      },
      {
        title: "Ekonomi Berkelanjutan",
        text: "Bisnis hebat bukan cuma cari untung, tapi juga menjaga alam.\n\nLimbah pabrik tempe bisa diolah jadi **Biogas** atau **Pakan Ternak**. \nCuan dapet, Bumi selamat!"
      }
    ]
  }
];

// --- DATA QUIZ (Updated) ---
const quizzes = {
  'quiz_1': [
    {
      question: "Inti masalah ekonomi adalah...",
      options: ["Uang terlalu banyak", "Kebutuhan tak terbatas vs Alat pemuas terbatas", "Barang terlalu murah", "Produksi berlebihan"],
      correct: 1,
      explanation: "Betul! Ini disebut Kelangkaan (Scarcity)."
    },
    {
      question: "Kegiatan ekonomi terdiri dari 3 hal utama, KECUALI...",
      options: ["Produksi", "Distribusi", "Korupsi", "Konsumsi"],
      correct: 2,
      explanation: "Jelas dong! Korupsi bukan kegiatan ekonomi yang produktif."
    }
  ],
  'quiz_2': [
    {
      question: "Ibu Siti mengubah kacang kedelai menjadi tempe. Nilai guna apa yang diciptakan?",
      options: ["Place Utility (Tempat)", "Form Utility (Bentuk)", "Time Utility (Waktu)", "Ownership Utility (Milik)"],
      correct: 1,
      explanation: "Tepat! Mengubah bentuk fisik bahan mentah menjadi barang jadi adalah Form Utility."
    },
    {
      question: "Manakah yang termasuk Faktor Produksi 'Modal'?",
      options: ["Air sungai", "Karyawan", "Mesin Pabrik & Uang", "Skill Manager"],
      correct: 2,
      explanation: "Benar! Modal (Capital) adalah alat penunjang seperti mesin atau uang."
    },
    {
      question: "Tujuan utama produksi adalah...",
      options: ["Mencapai Kemakmuran", "Menghabiskan bahan", "Mengisi waktu luang", "Gaya-gayaan"],
      correct: 0,
      explanation: "100! Produksi bertujuan memenuhi kebutuhan agar tercapai kemakmuran."
    }
  ],
  'quiz_3': [
    {
      question: "Tukang Bakso keliling menjual langsung ke pembeli. Ini distribusi jenis...",
      options: ["Tidak Langsung", "Semi-Langsung", "Langsung", "Online"],
      correct: 2,
      explanation: "Betul! Produsen bertemu langsung konsumen."
    },
    {
      question: "Hujan turun, harga payung mahal tapi tetap dibeli. Faktor apa ini?",
      options: ["Eksternal (Alam)", "Internal (Selera)", "Internal (Motivasi)", "Eksternal (Iklan)"],
      correct: 0,
      explanation: "Ya! Kondisi alam memaksa kebutuhan mendesak (Time Utility)."
    }
  ],
  'quiz_4': [
    {
      question: "Pemerintah menaikkan harga BBM bersubsidi. Dampak langsung bagi produsen keripik yang mengirim ke luar kota adalah...",
      options: ["Permintaan naik tajam", "Keuntungan bertambah", "Biaya distribusi naik, margin menipis", "Harga kedelai turun"],
      correct: 2,
      explanation: "Analisis Tepat! BBM adalah komponen utama distribusi."
    },
    {
      question: "Supply (Penawaran) melimpah, tapi Demand (Permintaan) tetap. Apa yang terjadi pada harga?",
      options: ["Harga TURUN", "Harga NAIK", "Harga stabil", "Petani kaya"],
      correct: 0,
      explanation: "Benar! Barang 'banjir' di pasar membuat harga jatuh (Hukum Penawaran)."
    },
    {
      question: "Mesin canggih menggantikan 10 orang pekerja. Ini risiko dari intensifikasi modal, yaitu...",
      options: ["Gaji naik", "Efisiensi tenaga kerja (Potensi PHK)", "Kualitas turun", "Produksi lambat"],
      correct: 1,
      explanation: "Kritis! Teknologi sering menggantikan peran tenaga kerja manual."
    }
  ],
  'quiz_5': [
    {
      question: "STUDI KASUS: Kedelai impor langka, harga naik 200%. Strategi terbaik?",
      options: ["Tutup pabrik", "Ganti batu kapur (curang)", "Kurangi ukuran sedikit (Shrinkflation)", "Naikkan harga 300%"],
      correct: 2,
      explanation: "Strategi CEO! Bertahan tanpa membuang pelanggan adalah kunci."
    },
    {
      question: "Kompetitor jual harga rugi (Predatory Pricing). Apa reaksi Anda?",
      options: ["Bakar pabriknya", "Ikut jual rugi", "Cari pasar baru (Blue Ocean)", "Tutup bisnis"],
      correct: 2,
      explanation: "Tepat! Hindari perang harga (Red Ocean), cari peluang baru."
    },
    {
      question: "Tren Healthy Lifestyle meningkat. Inovasi produk tempe apa yang cocok?",
      options: ["Tempe goreng minyak jelantah", "Keripik Tempe Oven (Low Fat)", "Tempe pengawet", "Jual kedelai mentah"],
      correct: 1,
      explanation: "Visioner! Produk relevan dengan tren pasar."
    }
  ],
  // NEW QUIZZES FOR LEVEL 6 & 7
  'quiz_6': [
    {
      question: "Anda ingin mengekspor Tempe ke Jepang. Syarat utama agar diterima pasar internasional adalah...",
      options: ["Harga semurah mungkin (Murahan)", "Kualitas Standar Internasional (ISO)", "Kemasan koran bekas", "Rasa yang sangat pedas"],
      correct: 1,
      explanation: "Benar! Pasar global menuntut standar kualitas dan higienitas tinggi (Quality Control)."
    },
    {
      question: "Apa manfaat utama bagi negara jika bisnis Anda berhasil ekspor?",
      options: ["Negara rugi barang", "Menambah Devisa Negara", "Mengurangi stok dalam negeri", "Tidak ada manfaat"],
      correct: 1,
      explanation: "Cerdas! Devisa (Mata uang asing) memperkuat ekonomi negara."
    },
    {
      question: "Hambatan perdagangan berupa pajak masuk barang ke negara lain disebut...",
      options: ["Tarif / Bea Masuk", "Kuota", "Embargo", "Dumping"],
      correct: 0,
      explanation: "Tepat! Bea masuk adalah pajak yang dikenakan pada barang impor."
    },
    {
      question: "Mengapa branding 'Superfood' cocok untuk memasarkan Tempe di Eropa?",
      options: ["Karena murah", "Karena orang Eropa suka gorengan", "Karena Tempe tinggi protein & nabati (Vegan Friendly)", "Karena namanya aneh"],
      correct: 2,
      explanation: "Analisis Pasar Jitu! Tren Vegan/Vegetarian di Eropa tinggi, tempe adalah solusi sempurna."
    }
  ],
  'quiz_7': [
    {
      question: "Apa yang dimaksud dengan Diversifikasi Bisnis?",
      options: ["Fokus hanya 1 produk seumur hidup", "Membuka berbagai jenis usaha untuk sebar risiko", "Menutup cabang", "Mengurangi karyawan"],
      correct: 1,
      explanation: "Konsep Tycoon! Jangan taruh semua telur dalam satu keranjang."
    },
    {
      question: "Pabrik Anda menghasilkan limbah air kedelai. Langkah 'Ekonomi Hijau' yang tepat adalah...",
      options: ["Buang ke sungai diam-diam", "Olah menjadi Pupuk Cair / Biogas", "Bayar preman untuk tutup mulut", "Pindah pabrik"],
      correct: 1,
      explanation: "Sustainability! Mengubah masalah (limbah) menjadi peluang (cuan/energi)."
    },
    {
      question: "Tujuan akhir dari seorang Tycoon Legendaris bukan sekadar uang, tapi...",
      options: ["Kekuasaan mutlak", "Kebermanfaatan jangka panjang (Sustainability)", "Membeli pulau pribadi", "Pamer di Medsos"],
      correct: 1,
      explanation: "Filosofi Bisnis! Bisnis yang bertahan ratusan tahun adalah yang bermanfaat bagi masyarakat dan alam."
    },
    {
      question: "Jika terjadi Resesi Global (ekonomi dunia lesu), apa yang menyelamatkan bisnis Anda?",
      options: ["Hutang bank sebanyak mungkin", "Dana Darurat (Cash Reserve) yang kuat", "Memecat semua orang", "Pasrah"],
      correct: 1,
      explanation: "Manajemen Risiko! Cash is King saat krisis terjadi."
    },
    {
      question: "Menciptakan lapangan kerja bagi 1.000 orang di desa adalah penerapan fungsi produksi untuk...",
      options: ["Pamer kekayaan", "Meningkatkan kesejahteraan masyarakat", "Menghindari pajak", "Eksploitasi manusia"],
      correct: 1,
      explanation: "Mulia! Ini adalah dampak sosial positif dari kegiatan ekonomi."
    }
  ]
};

const AVATARS = [
  { id: 'ceo_m', icon: 'üë®‚Äçüíº', label: 'CEO Muda' },
  { id: 'ceo_f', icon: 'üë©‚Äçüíº', label: 'CEO Keren' },
  { id: 'inv_m', icon: 'üë®‚Äçüíª', label: 'Investor' },
  { id: 'inv_f', icon: 'üë©‚Äçüíª', label: 'Founder' },
];

// --- DATA UPGRADE TYCOON ---
const TYCOON_UPGRADES = [
  {
    id: 'u1',
    name: "Resep Nenek",
    type: 'click',
    cost: 2500,
    value: 5,
    desc: "+5/klik (Inovasi)",
    icon: <BookOpen size={16} />
  },
  {
    id: 'u2',
    name: "Gerobak Dorong",
    type: 'auto',
    cost: 5000,
    value: 5,
    desc: "+5/detik (Distribusi)",
    icon: <ShoppingBag size={16} />
  },
  {
    id: 'u3',
    name: "Salesman Handal",
    type: 'auto',
    cost: 12000,
    value: 15,
    desc: "+15/detik (Tenaga Kerja)",
    icon: <Users size={16} />
  },
  {
    id: 'u4',
    name: "Mesin Potong",
    type: 'click',
    cost: 25000,
    value: 50,
    desc: "+50/klik (Modal)",
    icon: <Zap size={16} />
  },
  {
    id: 'u5',
    name: "Iklan Medsos",
    type: 'auto',
    cost: 45000,
    value: 60,
    desc: "+60/detik (Pemasaran)",
    icon: <Megaphone size={16} />
  },
  {
    id: 'u6',
    name: "Website Online",
    type: 'auto',
    cost: 75000,
    value: 120,
    desc: "+120/detik (Digital)",
    icon: <Globe size={16} />
  },
  {
    id: 'u7',
    name: "Buka Cabang",
    type: 'auto',
    cost: 150000,
    value: 300,
    desc: "+300/detik (Ekspansi)",
    icon: <Store size={16} />
  },
  {
    id: 'u8',
    name: "Ekspor Jepang",
    type: 'auto',
    cost: 300000,
    value: 1000,
    desc: "+1000/detik (Global)",
    icon: <Rocket size={16} />
  },
  {
    id: 'u9',
    name: "Pabrik Robotik",
    type: 'click',
    cost: 500000,
    value: 5000,
    desc: "+5000/klik (High Tech)",
    icon: <Gem size={16} />
  },
  {
    id: 'u10',
    name: "Monopoli Pasar",
    type: 'auto',
    cost: 1000000,
    value: 2500,
    desc: "+2500/detik (Tycoon)",
    icon: <Crown size={16} />
  }
];

// --- SUB-COMPONENT: MINI GAME TYCOON ---
const BusinessTycoon = ({ money, setMoney }) => {
  const [clickPower, setClickPower] = useState(1);
  const [autoClicker, setAutoClicker] = useState(0);

  // Auto clicker effect
  useEffect(() => {
    if (autoClicker > 0) {
      const interval = setInterval(() => {
        setMoney(m => m + autoClicker);
      }, 1000);
      return () => clearInterval(interval);
    }
  }, [autoClicker, setMoney]);

  const handleProduce = () => {
    setMoney(m => m + clickPower);
  };

  const buyUpgrade = (upgrade) => {
    if (money >= upgrade.cost) {
      setMoney(m => m - upgrade.cost);
      if (upgrade.type === 'click') setClickPower(c => c + upgrade.value);
      if (upgrade.type === 'auto') setAutoClicker(a => a + upgrade.value);
    }
  };

  return (
    <div className="bg-gradient-to-br from-slate-800 to-slate-900 text-white p-6 rounded-3xl shadow-xl border border-slate-700 relative overflow-hidden mb-8">
      <div className="absolute top-0 right-0 w-32 h-32 bg-emerald-500 rounded-full blur-[60px] opacity-20"></div>
      
      <div className="flex justify-between items-center mb-6 relative z-10">
        <div>
          <h3 className="text-lg font-bold flex items-center gap-2 text-emerald-400">
            <Coins size={20} /> BISNIS TEMPE TYCOON
          </h3>
          <p className="text-xs text-slate-400">Gunakan Dana Usaha untuk Investasi!</p>
        </div>
        <div className="text-right">
           <div className="bg-slate-900/50 border border-emerald-500/30 px-4 py-2 rounded-xl font-mono text-2xl font-bold text-emerald-400 shadow-inner">
            Rp {money.toLocaleString()}
          </div>
          <div className="text-[10px] text-slate-400 mt-1 flex gap-2 justify-end">
             <span>‚ö° {clickPower}/klik</span>
             <span>ü§ñ {autoClicker}/detik</span>
          </div>
        </div>
      </div>

      <div className="grid md:grid-cols-3 gap-6">
        {/* Area Produksi */}
        <div className="md:col-span-1 flex flex-col items-center justify-center bg-slate-800/50 rounded-2xl p-4 border border-slate-700/50">
          <button 
            onClick={handleProduce}
            className="w-32 h-32 bg-gradient-to-b from-indigo-500 to-indigo-700 hover:from-indigo-400 hover:to-indigo-600 rounded-full shadow-lg shadow-indigo-900/50 flex items-center justify-center text-5xl transition-all active:scale-90 border-4 border-indigo-300/30 group relative overflow-hidden"
          >
            <div className="absolute inset-0 bg-white/20 blur-xl opacity-0 group-hover:opacity-100 transition-opacity"></div>
            <span className="group-hover:scale-110 transition-transform block">ü´ò</span>
          </button>
          <div className="mt-4 text-center">
            <div className="text-sm font-bold text-indigo-200">KLIK PRODUKSI</div>
            <div className="text-[10px] text-slate-400">Hasilkan Tempe Manual</div>
          </div>
        </div>

        {/* Area Upgrade List */}
        <div className="md:col-span-2">
          <h4 className="text-sm font-bold text-slate-300 mb-3 flex items-center gap-2">
            <TrendingUp size={14} /> PASAR UPGRADE
          </h4>
          <div className="space-y-2 max-h-[200px] overflow-y-auto pr-2 custom-scrollbar">
            {TYCOON_UPGRADES.map((item) => (
              <button 
                key={item.id}
                onClick={() => buyUpgrade(item)}
                disabled={money < item.cost}
                className="w-full flex justify-between items-center p-3 bg-slate-700/50 rounded-xl border border-slate-600 hover:bg-slate-700 disabled:opacity-40 disabled:cursor-not-allowed transition-all group"
              >
                <div className="flex items-center gap-3 text-left">
                  <div className={`p-2 rounded-lg ${money >= item.cost ? 'bg-emerald-900/50 text-emerald-400' : 'bg-slate-800 text-slate-500'}`}>
                    {item.icon}
                  </div>
                  <div>
                    <div className="text-sm font-bold group-hover:text-white text-slate-200">{item.name}</div>
                    <div className="text-[10px] text-slate-400">{item.desc}</div>
                  </div>
                </div>
                <div className={`px-3 py-1.5 rounded-lg text-xs font-bold whitespace-nowrap ${money >= item.cost ? 'bg-emerald-600 text-white shadow-lg shadow-emerald-900/20' : 'bg-slate-800 text-slate-500'}`}>
                  Rp {item.cost.toLocaleString()}
                </div>
              </button>
            ))}
          </div>
        </div>
      </div>
    </div>
  );
};

// --- MAIN COMPONENTS ---

const WelcomeScreen = ({ playerData, setPlayerData, handleStart }) => (
  <div className="min-h-screen bg-slate-900 flex items-center justify-center p-4 font-sans relative overflow-hidden">
    <div className="absolute top-[-10%] left-[-10%] w-96 h-96 bg-indigo-600 rounded-full blur-3xl opacity-30 animate-pulse"></div>
    
    <div className="bg-white/10 backdrop-blur-lg border border-white/20 p-8 rounded-3xl w-full max-w-md shadow-2xl z-10 text-center">
      <div className="inline-flex p-4 bg-indigo-600 rounded-2xl shadow-lg shadow-indigo-500/50 mb-6 transform -rotate-3 hover:rotate-0 transition-transform">
        <Target className="text-white w-10 h-10" />
      </div>
      <h1 className="text-3xl md:text-4xl font-black text-white mb-2 tracking-tight">Caroluspreuner</h1>
      <p className="text-indigo-200 mb-8">Mulai dari Nol, Jadi Konglomerat!</p>

      <div className="space-y-6">
        <div>
          <label className="text-indigo-200 text-xs font-bold uppercase tracking-wider mb-3 block">Pilih Avatar CEO</label>
          <div className="flex justify-center gap-3">
            {AVATARS.map((av) => (
              <button
                key={av.id}
                onClick={() => setPlayerData(prev => ({ ...prev, avatar: av.id }))}
                className={`w-14 h-14 text-2xl rounded-xl flex items-center justify-center transition-all transform hover:scale-110 border-2 ${playerData.avatar === av.id ? 'bg-indigo-600 border-indigo-400 shadow-lg shadow-indigo-500/50 scale-110' : 'bg-white/10 border-transparent hover:bg-white/20'}`}
              >
                {av.icon}
              </button>
            ))}
          </div>
        </div>

        <div className="text-left">
          <label className="text-indigo-200 text-xs font-bold uppercase tracking-wider mb-2 block">Nama Founder</label>
          <input 
            type="text"
            value={playerData.name}
            onChange={(e) => setPlayerData(prev => ({ ...prev, name: e.target.value }))}
            placeholder="Ketik namamu..."
            className="w-full bg-slate-800/50 border border-indigo-500/30 text-white p-4 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:border-transparent transition-all placeholder-slate-500 font-bold"
          />
        </div>

        <button 
          onClick={handleStart}
          disabled={!playerData.name}
          className="w-full bg-gradient-to-r from-indigo-500 to-purple-600 hover:from-indigo-400 hover:to-purple-500 text-white font-black py-4 rounded-xl shadow-lg shadow-indigo-900/50 transform transition-all active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2 group"
        >
          MULAI PETUALANGAN <ArrowRight className="group-hover:translate-x-1 transition-transform" />
        </button>
      </div>
    </div>
  </div>
);

const MenuScreen = ({ playerData, score, unlockedLevels, startModule, startQuiz, businessMoney, setBusinessMoney }) => {
  const avatarIcon = AVATARS.find(a => a.id === playerData.avatar)?.icon || 'üòä';
  
  return (
    <div className="min-h-screen bg-slate-50 font-sans pb-12">
      <div className="bg-slate-900 text-white pt-8 pb-20 px-6 rounded-b-[2.5rem] shadow-xl relative overflow-hidden z-0">
        <div className="absolute top-0 right-0 w-64 h-64 bg-indigo-600 rounded-full blur-[100px] opacity-40"></div>
        <div className="max-w-xl mx-auto flex items-center justify-between relative z-10">
          <div>
            <p className="text-indigo-300 text-xs font-bold uppercase tracking-widest mb-1">Markas Pusat</p>
            <h2 className="text-2xl font-bold truncate max-w-[200px]">Halo, {playerData.name}</h2>
            <div className="flex items-center gap-2 mt-2">
               <div className="bg-indigo-800/80 px-3 py-1 rounded-full flex items-center gap-1 text-xs font-bold text-yellow-400">
                  <Star size={12} fill="currentColor" /> {score} XP
               </div>
               <div className="bg-emerald-800/80 px-3 py-1 rounded-full flex items-center gap-1 text-xs font-bold text-emerald-400 animate-pulse">
                  <Coins size={12} /> Rp {businessMoney.toLocaleString()}
               </div>
            </div>
          </div>
          <div className="bg-white/10 backdrop-blur-md p-3 rounded-2xl text-4xl border border-white/10 shadow-inner transform hover:scale-105 transition-transform">
            {avatarIcon}
          </div>
        </div>
      </div>

      <div className="max-w-xl mx-auto px-6 -mt-12 relative z-10">
        
        {/* MINI GAME TYCOON */}
        <BusinessTycoon money={businessMoney} setMoney={setBusinessMoney} />

        <h3 className="font-bold text-slate-800 text-lg mb-4 flex items-center gap-2">
          <Briefcase size={20} className="text-slate-400" /> Peta Perjalanan
        </h3>
        
        <div className="space-y-4">
          {LEVELS.map((lvl, idx) => {
            const isUnlocked = unlockedLevels.includes(lvl.id);
            
            return (
              <div key={lvl.id} className={`relative group ${!isUnlocked ? 'opacity-75 grayscale' : ''}`}>
                {/* Connector Line */}
                {idx < LEVELS.length - 1 && (
                   <div className="absolute left-8 top-16 w-1 h-12 bg-slate-200 -z-10"></div>
                )}

                <div className={`bg-white p-5 rounded-2xl shadow-sm border-2 ${isUnlocked ? lvl.accent : 'border-slate-200'} transition-all hover:shadow-md`}>
                  <div className="flex items-start justify-between mb-4">
                    <div className="flex items-center gap-4">
                      <div className={`${isUnlocked ? lvl.color : 'bg-slate-200'} p-3 rounded-xl text-white shadow-lg`}>
                        {isUnlocked ? lvl.icon : <Lock size={24} />}
                      </div>
                      <div>
                        <div className="flex items-center gap-2">
                          <h4 className="font-bold text-slate-800">{lvl.title}</h4>
                          <span className={`text-[10px] px-1.5 py-0.5 rounded font-bold uppercase ${
                            lvl.difficulty === 'Legend' ? 'bg-yellow-100 text-yellow-700' : 
                            lvl.difficulty === 'Master' ? 'bg-cyan-100 text-cyan-700' : 
                            lvl.difficulty === 'Expert' ? 'bg-violet-100 text-violet-700' : 
                            lvl.difficulty === 'Hard' ? 'bg-rose-100 text-rose-600' : 'bg-slate-100 text-slate-500'
                          }`}>
                            {lvl.difficulty}
                          </span>
                        </div>
                        <p className="text-xs text-slate-500 font-medium">{lvl.subtitle}</p>
                      </div>
                    </div>
                    <div className="text-right">
                       <div className="text-[10px] text-slate-400 uppercase font-bold">Hadiah</div>
                       <div className="text-sm font-bold text-emerald-600">Rp {lvl.rewardMoney.toLocaleString()}</div>
                    </div>
                  </div>

                  {isUnlocked ? (
                    <div className="flex gap-2">
                      <button 
                        onClick={() => startModule(lvl.materialIds[0])}
                        className="flex-1 bg-slate-50 hover:bg-slate-100 text-slate-600 text-sm font-bold py-2 rounded-lg border border-slate-200 flex items-center justify-center gap-2 transition-colors"
                      >
                        <BookOpen size={16} /> Pelajari
                      </button>
                      <button 
                        onClick={() => startQuiz(lvl.quizId, lvl.id, lvl.rewardMoney)}
                        className={`flex-1 ${lvl.color} hover:brightness-110 text-white text-sm font-bold py-2 rounded-lg shadow-md flex items-center justify-center gap-2 transition-transform active:scale-95`}
                      >
                        <Play size={16} fill="currentColor" /> Ujian
                      </button>
                    </div>
                  ) : (
                    <div className="bg-slate-100 p-2 rounded-lg text-center text-xs font-bold text-slate-400 flex items-center justify-center gap-2">
                       <Lock size={12} /> Selesaikan Level Sebelumnya
                    </div>
                  )}
                </div>
              </div>
            );
          })}
        </div>
      </div>
    </div>
  );
};

const LearnScreen = ({ activeMaterialId, slideIndex, setSlideIndex, setScreen }) => {
  const module = studyMaterials[activeMaterialId];
  if (!module) return <div>Loading...</div>;

  const slide = module.content[slideIndex];
  const progress = ((slideIndex + 1) / module.content.length) * 100;

  return (
    <div className="min-h-screen bg-slate-50 flex flex-col relative overflow-hidden">
       <div className="h-2 w-full bg-slate-200 fixed top-0 z-30">
          <div className="h-full bg-indigo-500 transition-all duration-500 ease-out" style={{width: `${progress}%`}}></div>
       </div>

      <div className="flex-1 flex flex-col p-6 pt-8 max-w-2xl mx-auto w-full pb-24">
        <div className="flex justify-between items-center mb-6">
          <button onClick={() => setScreen('menu')} className="bg-white p-2 rounded-full border border-slate-200 text-slate-600 hover:bg-slate-100 shadow-sm z-20">
            <XCircle size={24} />
          </button>
          <div className="px-3 py-1 rounded-full bg-white border border-slate-200 text-xs font-bold text-slate-500 shadow-sm z-20">
            {slideIndex + 1} / {module.content.length}
          </div>
        </div>

        <div className="bg-white rounded-[2rem] shadow-2xl shadow-slate-200 border-2 border-slate-100 overflow-hidden flex flex-col relative animate-fade-in-up h-full min-h-[400px]">
          <div className="bg-indigo-100 h-40 flex items-center justify-center relative shrink-0">
             <div className="absolute inset-0 bg-black/5 pattern-grid-lg opacity-20"></div>
             <div className="text-7xl filter drop-shadow-lg transform hover:scale-110 transition-transform cursor-default">
               {module.emoji}
             </div>
          </div>

          <div className="p-8 flex-1 overflow-y-auto">
            <h2 className="text-2xl font-black text-slate-800 mb-4 pb-4 border-b-2 border-indigo-100">
              {slide.title}
            </h2>
            <p className="text-slate-600 leading-relaxed text-lg whitespace-pre-line">
              <FormatText text={slide.text} />
            </p>
          </div>
        </div>
      </div>

      <div className="fixed bottom-0 left-0 w-full p-4 bg-white/80 backdrop-blur border-t border-slate-200 flex justify-center gap-4 z-30">
         <button 
            onClick={() => setSlideIndex(Math.max(0, slideIndex - 1))}
            disabled={slideIndex === 0}
            className="flex-1 p-4 rounded-xl bg-slate-100 text-slate-400 font-bold hover:bg-slate-200 hover:text-slate-600 disabled:opacity-50 transition-all flex justify-center items-center"
          >
            <ChevronLeft size={24} />
          </button>

          {slideIndex < module.content.length - 1 ? (
            <button 
              onClick={() => setSlideIndex(slideIndex + 1)}
              className="flex-[2] p-4 rounded-xl bg-indigo-600 hover:bg-indigo-700 text-white font-bold shadow-lg transform hover:scale-[1.02] transition-all flex justify-center items-center gap-2"
            >
              Lanjut <ArrowRight size={24} />
            </button>
          ) : (
            <button 
              onClick={() => setScreen('menu')}
              className="flex-[2] p-4 bg-slate-800 hover:bg-slate-700 text-white rounded-xl font-bold shadow-lg transform hover:scale-[1.02] transition-all flex justify-center items-center gap-2"
            >
              Selesai <CheckCircle size={20} />
            </button>
          )}
      </div>
    </div>
  );
};

const GameScreen = ({ quizId, currentQuestionIdx, health, score, feedback, handleAnswer, nextQuestion }) => {
  const questionList = quizzes[quizId];
  const question = questionList[currentQuestionIdx];

  return (
    <div className="min-h-screen bg-slate-900 flex flex-col items-center justify-center p-4 font-sans relative">
      <div className={`absolute inset-0 transition-colors duration-500 ${feedback === 'correct' ? 'bg-emerald-900/50' : feedback === 'wrong' ? 'bg-rose-900/50' : 'bg-slate-900'}`}></div>
      
      <div className="absolute top-0 left-0 w-full p-6 flex justify-between items-start z-20">
        <div className="bg-slate-800/80 backdrop-blur border border-slate-700 p-3 rounded-2xl flex items-center gap-3 shadow-xl">
           <div className="flex gap-1">
            {[...Array(3)].map((_, i) => (
              <Heart key={i} size={24} className={`${i < health ? 'fill-rose-500 text-rose-500' : 'fill-slate-700 text-slate-700'} transition-all duration-300 ${i < health ? 'animate-pulse' : ''}`} />
            ))}
          </div>
        </div>
        <div className="bg-slate-800/80 backdrop-blur border border-slate-700 px-4 py-2 rounded-2xl font-mono font-bold text-yellow-400 text-xl shadow-xl">
          {score} XP
        </div>
      </div>

      <div className="w-full max-w-xl relative z-10 mt-16 mb-8">
        <div className="bg-white rounded-3xl shadow-2xl overflow-hidden">
          <div className="bg-indigo-100 p-6 text-center border-b border-indigo-200">
             <span className="inline-block bg-indigo-600 text-white text-xs font-bold px-3 py-1 rounded-full mb-3 tracking-wider">
               SOAL {currentQuestionIdx + 1} / {questionList.length}
             </span>
             <h3 className="text-lg md:text-xl font-bold text-slate-800 leading-snug">
               <FormatText text={question.question} />
             </h3>
          </div>

          <div className="p-5 bg-slate-50 space-y-3">
            {question.options.map((opt, idx) => {
              let style = "bg-white border-2 border-slate-200 text-slate-600 hover:border-indigo-400 hover:shadow-md";
              let icon = <div className="w-8 h-8 shrink-0 rounded-full bg-slate-100 text-slate-500 flex items-center justify-center font-bold text-sm">{String.fromCharCode(65+idx)}</div>;

              if (feedback) {
                 if (idx === question.correct) {
                   style = "bg-emerald-100 border-emerald-500 text-emerald-800 shadow-none ring-2 ring-emerald-200";
                   icon = <CheckCircle className="text-emerald-600 shrink-0" />;
                 } else if (feedback === 'wrong' && isNaN(feedback)) {
                   style = "opacity-50 grayscale";
                 }
              }

              return (
                <button
                  key={idx}
                  disabled={feedback !== null}
                  onClick={() => handleAnswer(idx, question.correct)}
                  className={`w-full p-4 rounded-2xl text-left font-bold transition-all duration-200 flex items-center gap-3 ${style} active:scale-95`}
                >
                  {icon}
                  <span className="flex-1 text-sm md:text-base"><FormatText text={opt} /></span>
                </button>
              );
            })}
          </div>

          {feedback && (
            <div className={`p-6 border-t-2 animate-slide-up ${feedback === 'correct' ? 'bg-emerald-50 border-emerald-100' : 'bg-rose-50 border-rose-100'}`}>
              <div className={`flex items-center gap-2 font-black mb-2 ${feedback === 'correct' ? 'text-emerald-600' : 'text-rose-600'}`}>
                {feedback === 'correct' ? <CheckCircle /> : <XCircle />}
                {feedback === 'correct' ? 'LUAR BIASA!' : 'KURANG TEPAT...'}
              </div>
              <p className="text-slate-700 text-sm mb-4 leading-relaxed"><FormatText text={question.explanation} /></p>
              <button 
                onClick={nextQuestion}
                className={`w-full py-4 rounded-xl font-black text-white shadow-lg transform hover:scale-[1.02] transition-all flex justify-center items-center gap-2 ${feedback === 'correct' ? 'bg-emerald-500 hover:bg-emerald-600' : 'bg-rose-500 hover:bg-rose-600'}`}
              >
                LANJUT <ArrowRight size={20} />
              </button>
            </div>
          )}
        </div>
      </div>
    </div>
  );
};

const ResultScreen = ({ score, currentLevelId, unlockNextLevel, setScreen, resetQuiz, potentialReward, totalQuestions }) => {
  const isPass = score >= 100;
  // Bonus Logic: If perfect score (all questions correct), get 2x Reward
  const isPerfect = score === (totalQuestions * 50); 
  const finalReward = isPass ? (isPerfect ? potentialReward * 2 : potentialReward) : 0;

  return (
    <div className="min-h-screen bg-slate-100 flex items-center justify-center p-6 font-sans">
      <div className="bg-white w-full max-w-lg shadow-2xl rounded-3xl overflow-hidden relative border-8 border-double border-indigo-100">
        <div className="bg-slate-900 p-12 text-center relative overflow-hidden">
          <div className="relative z-10">
            <div className="w-28 h-28 mx-auto bg-gradient-to-b from-yellow-300 to-yellow-500 rounded-full flex items-center justify-center shadow-2xl border-4 border-white/20 mb-4 animate-bounce">
              <span className="text-6xl drop-shadow-md">{isPass ? 'üöÄ' : 'üìâ'}</span>
            </div>
            <h2 className="text-2xl font-black text-white tracking-tight uppercase">{isPass ? 'MISI SUKSES!' : 'MISI GAGAL'}</h2>
            {isPerfect && isPass && <div className="text-yellow-400 font-bold text-sm bg-slate-800/50 inline-block px-3 py-1 rounded-full mt-2 border border-yellow-500 animate-pulse">PERFECT SCORE! BONUS 2X</div>}
            <p className="text-indigo-300 text-sm mt-1">{isPass ? 'Kamu siap naik pangkat!' : 'Belajar lagi yuk...'}</p>
          </div>
        </div>

        <div className="p-8 text-center">
           <div className="grid grid-cols-2 gap-4 mb-8">
             <div className="bg-indigo-50 p-4 rounded-2xl border border-indigo-100">
               <p className="text-xs text-indigo-400 font-bold uppercase">XP Didapat</p>
               <p className="text-3xl font-black text-indigo-700">{score}</p>
             </div>
             <div className="bg-emerald-50 p-4 rounded-2xl border border-emerald-100">
               <p className="text-xs text-emerald-500 font-bold uppercase">Dana Cair</p>
               <p className="text-xl font-bold text-emerald-700 leading-tight mt-1">Rp {finalReward.toLocaleString()}</p>
             </div>
           </div>

           <div className="flex flex-col gap-3">
              {isPass ? (
                <button onClick={() => { unlockNextLevel(currentLevelId, finalReward); setScreen('menu'); }} className="w-full py-4 bg-emerald-600 text-white font-bold rounded-xl hover:bg-emerald-700 transition-all shadow-lg flex justify-center items-center gap-2 animate-pulse">
                   <Award size={18} /> KLAIM HADIAH & LANJUT
                </button>
              ) : (
                <button onClick={resetQuiz} className="w-full py-4 bg-slate-900 text-white font-bold rounded-xl hover:bg-slate-800 transition-all shadow-lg flex justify-center items-center gap-2">
                   <RefreshCcw size={18} /> ULANGI UJIAN
                </button>
              )}
              <button onClick={() => setScreen('menu')} className="w-full py-4 bg-white text-slate-700 border-2 border-slate-200 font-bold rounded-xl hover:bg-slate-50 transition-all flex justify-center items-center gap-2">
                 <Home size={18} /> KEMBALI KE MARKAS
              </button>
           </div>
        </div>
      </div>
    </div>
  );
};

// --- MAIN APP ---

const App = () => {
  const [screen, setScreen] = useState('welcome'); 
  const [playerData, setPlayerData] = useState({ name: '', avatar: 'ceo_m' });
  
  // State for Progress
  const [unlockedLevels, setUnlockedLevels] = useState([1]); 
  const [totalXP, setTotalXP] = useState(0);
  const [businessMoney, setBusinessMoney] = useState(0);

  // State for Learning/Quiz Session
  const [activeLevelId, setActiveLevelId] = useState(null);
  const [activeMaterialId, setActiveMaterialId] = useState(0);
  const [activeQuizId, setActiveQuizId] = useState(null);
  const [activeReward, setActiveReward] = useState(0); // New: Store reward for current level
  
  const [slideIndex, setSlideIndex] = useState(0);
  const [currentQuestionIdx, setCurrentQuestionIdx] = useState(0);
  const [sessionScore, setSessionScore] = useState(0);
  const [health, setHealth] = useState(3);
  const [feedback, setFeedback] = useState(null);

  const handleStart = () => {
    if (playerData.name.trim()) {
      setScreen('menu');
    }
  };

  const startModule = (materialId) => {
    setActiveMaterialId(materialId);
    setSlideIndex(0);
    setScreen('learn');
  };

  const startQuiz = (quizId, levelId, rewardMoney) => {
    setActiveQuizId(quizId);
    setActiveLevelId(levelId);
    setActiveReward(rewardMoney); // Set reward
    setCurrentQuestionIdx(0);
    setSessionScore(0);
    setHealth(3);
    setFeedback(null);
    setScreen('game');
  };

  const handleAnswer = (optionIndex, correctIndex) => {
    const isCorrect = optionIndex === correctIndex;
    
    if (isCorrect) {
      setSessionScore(s => s + 50); 
      setFeedback('correct');
    } else {
      setHealth(h => h - 1);
      setFeedback('wrong');
    }
  };

  const nextQuestion = () => {
    setFeedback(null);
    const quizLen = quizzes[activeQuizId].length;

    if (currentQuestionIdx < quizLen - 1) {
      setCurrentQuestionIdx(c => c + 1);
    } else {
      setScreen('result');
    }
  };

  const resetQuiz = () => {
    startQuiz(activeQuizId, activeLevelId, activeReward);
  };

  const unlockNextLevel = (completedLevelId, earnedMoney) => {
    setTotalXP(t => t + sessionScore); 
    setBusinessMoney(m => m + earnedMoney); // ADD REAL MONEY REWARD HERE!
    
    if (!unlockedLevels.includes(completedLevelId + 1)) {
       setUnlockedLevels(prev => [...prev, completedLevelId + 1]);
    }
  };

  useEffect(() => {
    if (health === 0 && screen === 'game') {
      setTimeout(() => setScreen('result'), 1000);
    }
  }, [health, screen]);

  return (
    <>
      {screen === 'welcome' && <WelcomeScreen playerData={playerData} setPlayerData={setPlayerData} handleStart={handleStart} />}
      
      {screen === 'menu' && 
        <MenuScreen 
          playerData={playerData} 
          score={totalXP} 
          unlockedLevels={unlockedLevels}
          startModule={startModule} 
          startQuiz={startQuiz}
          businessMoney={businessMoney}
          setBusinessMoney={setBusinessMoney}
        />
      }
      
      {screen === 'learn' && 
        <LearnScreen 
          activeMaterialId={activeMaterialId} 
          slideIndex={slideIndex} 
          setSlideIndex={setSlideIndex} 
          setScreen={setScreen} 
        />
      }
      
      {screen === 'game' && 
        <GameScreen 
          quizId={activeQuizId}
          currentQuestionIdx={currentQuestionIdx} 
          health={health} 
          score={sessionScore} 
          feedback={feedback} 
          handleAnswer={handleAnswer} 
          nextQuestion={nextQuestion} 
        />
      }
      
      {screen === 'result' && 
        <ResultScreen 
          score={sessionScore} 
          currentLevelId={activeLevelId}
          unlockNextLevel={unlockNextLevel}
          setScreen={setScreen} 
          resetQuiz={resetQuiz}
          potentialReward={activeReward}
          totalQuestions={quizzes[activeQuizId]?.length || 0}
        />
      }
    </>
  );
};

export default App;